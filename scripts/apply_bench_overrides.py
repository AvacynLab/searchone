"""
Apply benchmark-based overrides to backend/config.json.
Reads data/bench_overrides.json (generated by bench_report.py) and updates model/profile settings.
"""
import json
from pathlib import Path

ROOT = Path(__file__).resolve().parent.parent
CONFIG_PATH = ROOT / "backend" / "config.json"
OVERRIDES_PATH = ROOT / "data" / "bench_overrides.json"


def load_json(path: Path) -> dict:
    if not path.exists():
        return {}
    try:
        return json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        return {}


def main():
    overrides = load_json(OVERRIDES_PATH)
    if not overrides:
        print(f"No overrides found at {OVERRIDES_PATH}, nothing to apply.")
        return
    cfg = load_json(CONFIG_PATH)
    cfg.setdefault("bench_overrides_applied", [])
    cfg.setdefault("sampling", {})
    cfg.setdefault("role_models", {})

    for ov in overrides if isinstance(overrides, list) else []:
        profile = ov.get("recommended_profile")
        temp = ov.get("temperature")
        label = ov.get("query") or "generic"
        if profile:
            cfg["role_models"][label] = profile
        if temp is not None:
            cfg["sampling"][label] = {"temperature": temp}
        cfg["bench_overrides_applied"].append({"query": label, "profile": profile, "temperature": temp})

    CONFIG_PATH.parent.mkdir(parents=True, exist_ok=True)
    CONFIG_PATH.write_text(json.dumps(cfg, ensure_ascii=False, indent=2), encoding="utf-8")
    print(f"Applied {len(cfg['bench_overrides_applied'])} overrides into {CONFIG_PATH}")


if __name__ == "__main__":
    main()
